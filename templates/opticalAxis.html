<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- JS 引入（与 index/login/serialSetting 保持一致） -->
    <script type="text/javascript" src="/static/jsscripts/vue.js"></script>
    <script type="text/javascript" src="/static/jsscripts/axios.js"></script>
    <script type="text/javascript" src="/static/jsscripts/elementui/lib-master/index.js"></script>

    <!-- 样式引入 -->
    <link rel="stylesheet" href="/static/jsscripts/elementui/lib-master/theme-chalk/index.css">

    <!-- Socket引入 -->
    <script type="text/javascript" src="/static/jsscripts/socket.io.js"></script>

    <title>光轴对准</title>

    <style>
        html{ height:calc(100%); }
        body{ background:#f5f7fa; margin:0; height:100%; overflow-y:hidden; }
        .page{ padding:16px; }
        .card{ margin-bottom:12px; }
        .toolbar{ display:flex; gap:8px; align-items:center; }
        .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
        .steps-bar{ flex:1; min-width:0; }
        /* 压缩 Steps 高度与字号，使整体更“矮” */
        .el-steps--simple{ padding:6px 8px; background:transparent; }
        .el-steps--simple .el-step__title{ font-size:12px; }
        .el-steps--simple .el-step__head.is-process, 
        .el-steps--simple .el-step__head.is-finish{ transform:scale(0.9); }
        .el-steps--simple .el-step__arrow{ transform:scale(0.9); }
        /* 次要文字色与 serialSetting 风格一致 */
        .subtle{ color:#909399; }
        .placeholder{
            height:320px;
            border:1px dashed #dcdfe6;
            background: #fff;
            border-radius:4px;
            display:flex;
            align-items:center;
            justify-content:center;
            color:#c0c4cc;
        }
        /* 更紧凑的顶部行高度 */
        .topbar-card .el-card__body{ padding:6px 10px; }
        .topbar-card .row{ gap:8px; }
        .topbar-card .el-steps--simple{ padding:2px 6px; }
        .topbar-card .el-steps--simple .el-step__title{ font-size:12px; line-height:16px; }
        .topbar-card .toolbar .el-button--mini{ padding:2px 8px; line-height:16px; height:22px; }
        .topbar-card .subtle{ font-size:12px; }
        /* L 形布局：左大（相机），右侧栏通高，底部在左下 */
        .camera-layout{ 
            display:grid; 
            grid-template-columns: 1.4fr 840px; 
            grid-template-rows: auto 100px; 
            grid-template-areas: 'cam side' 'bottom side';
            gap:12px; 
        }
        .panel{
            background:#fff;
            border:1px solid #ebeef5;
            border-radius:4px;
            overflow:hidden;
            display:flex;
            flex-direction:column;
            min-width:0;
        }
        .panel__hd{ 
            padding:8px 10px; 
            border-bottom:1px solid #ebeef5; 
            font-weight:500; 
            font-size:13px; 
            color:#606266; 
            display:flex; align-items:center; justify-content:space-between;
        }
        .panel__bd{ flex:1; display:flex; align-items:center; justify-content:center; background:#fafafa; }
        .panel__bd--cam{ background:#000; color:#909399; }
        .panel__bd canvas, .panel__bd img{ max-width:100%; max-height:100%; display:block; }
        .area-cam{ grid-area: cam; }
        .area-side{ grid-area: side; }
        .area-bottom{ grid-area: bottom; }
        /* 固定 4:3 的相机区域（不随图像比例变化） */
        .cam-viewport{ 
            --cam-aspect: 75%; /* 4:3 */
            position:relative; 
            width:100%; 
            background:#000;
            max-width: calc((100vh - 320px) * 1.333);
            margin: 0 auto;
        }
        .cam-viewport::before{ content:""; display:block; padding-top: var(--cam-aspect); }
        .cam-viewport__media{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; display: block;}
        .cam-viewport__placeholder{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#c0c4cc; font-size:12px; }
        @media (max-width: 1366px){
            .camera-layout{ grid-template-columns: 1.2fr 760px; grid-template-rows: auto 100px; }
        }
        /* 侧栏阶段模块 */
        .stage-item{ padding:10px; border:1px solid #ebeef5; border-radius:4px; background:#fff; }
        .stage-item--active{ border-color:#409EFF; background:#ecf5ff; }
        .stage-item__title{ font-weight:500; color:#303133; margin-bottom:4px; }
        .stage-item__desc{ font-size:12px; color:#909399; }
        /* 测试结果区域行间距适当增大 */
        .stage-item--result .toolbar{ margin-top:6px; }
        .area-side .panel__bd{ display:flex; flex-direction:column; align-items:stretch; justify-content:flex-start; gap:8px; padding:10px; }
        /* --- 测试结果状态文本样式 --- */
        .text-placeholder { color: #C0C4CC; } /* 未输入：灰色 */
        .text-value { color: #303133; font-weight: 600; } /* 已输入：加深高亮 */
        .text-highlight-red { color: #F56C6C; font-weight: bold; font-size: 15px; } /* 最终结果：红色加粗 */

        /* --- 新增：针对相机显示区的头部样式覆写 --- */
        .area-cam .panel__hd {
            flex-direction: column;  /* 改为纵向排列：标题在上，按钮在下 */
            align-items: flex-start; /* 内容左对齐 */
            gap: 6px;                /* 标题和按钮之间的间距 */
            padding: 6px 10px;       /* 稍微调整内边距以保持紧凑 */
            height: auto;            /* 允许高度随内容自动撑开 */
        }

        /* 确保原来右侧的工具栏占满宽度或保持左对齐，并处理间距 */
        .area-cam .panel__hd .toolbar {
            margin-top: 2px;         /* 增加一点顶部微调 */
            width: 100%;             /* 让工具栏宽度铺开 */
            justify-content: flex-start; /* 按钮从左侧开始排列 */
        }
    </style>
</head>
<body>
<div id="app" class="page">
    <!-- 顶部：步骤条 + 上一步/下一步（同一行，紧凑高度） -->
    <el-card class="card topbar-card" shadow="never">
        <div class="row">
            <div class="steps-bar">
                <el-steps :active="currentStep" simple finish-status="success" process-status="process">
                    <el-step v-for="(s, idx) in steps" :key="s.key" :title="s.title"></el-step>
                </el-steps>
            </div>
            <div class="toolbar">
                <span class="subtle">步骤：{{ currentStep+1 }}/{{ steps.length }}</span>
                <el-button size="mini" icon="el-icon-arrow-left" @click="prevStep" :disabled="currentStep===0">上一步</el-button>
                <el-button size="mini" type="primary" @click="nextStep">
                    {{ currentStep === steps.length - 1 ? "新一轮测试" : "下一步"}}
                    <i :class="currentStep === steps.length - 1 ? 'el-icon-refresh' : 'el-icon-arrow-right el-icon--right'"></i>
                </el-button>
            </div>
        </div>
    </el-card>

    <!-- 下方区域：L 形布局（div 容器，无标题） -->
    <div class="card">
        <div class="camera-layout">
            <!-- 左侧大面积：相机显示 -->
            <div class="panel area-cam">
                <div class="panel__hd">
                    <div>相机显示区</div>
                    <div class="toolbar">
                        <el-button-group style="margin-right: 10px;">
                            <el-button 
                                size="mini" 
                                icon="el-icon-crop" 
                                @click="toggleZoomMode" 
                                :type="isZoomMode ? 'warning' : 'default'"
                                title="点击开启框选放大">
                            </el-button>
                            <el-button size="mini" icon="el-icon-full-screen" @click="resetZoom" title="复位全图"></el-button>
                        </el-button-group>
                        <span v-if="viewRect" style="font-size:12px; color:#E6A23C; margin-right:10px; font-weight:bold;">局部放大中</span>
                        <el-select v-model="selectedCamera" size="mini" placeholder="选择相机" style="width:160px">
                            <el-option v-for="cam in cameraList" :key="cam.value" :label="cam.label" :value="cam.value"></el-option>
                        </el-select>
                        <input 
                            type="file" 
                            ref="uploadInput" 
                            accept="image/*" 
                            style="display: none" 
                            @change="handleImageUpload"
                        >
                        <el-button
                            v-if="selectedCamera === 4"
                            size="mini"
                            type="primary"
                            icon="el-icon-upload2"
                            @click="$refs.uploadInput.click()"
                            style="margin-right: 10px;"
                        >
                            上传图片
                        </el-button>
                        <el-dropdown :hide-on-click="false" trigger="click">
                            <el-button size="mini">
                                显示设置<i class="el-icon-arrow-down el-icon--right"></i>
                            </el-button>
                            <el-dropdown-menu slot="dropdown">
                                <el-dropdown-item>
                                    <el-checkbox v-model="drawCentroid">绘制质心</el-checkbox>
                                </el-dropdown-item>
                                <el-dropdown-item>
                                    <el-checkbox v-model="drawCross">绘制十字</el-checkbox>
                                </el-dropdown-item>
                                <el-dropdown-item>
                                    <el-checkbox v-model="showOriginal">显示原图</el-checkbox>
                                </el-dropdown-item>
                            </el-dropdown-menu>
                        </el-dropdown>
                        <!-- 相机设置下拉菜单 - 根据相机类型显示不同UI -->
                        <el-dropdown :hide-on-click="false" trigger="click" v-if="selectedCamera !== 4">
                            <el-button size="mini" icon="el-icon-setting">
                                相机设置<i class="el-icon-arrow-down el-icon--right"></i>
                            </el-button>
                            <el-dropdown-menu slot="dropdown" style="width: 260px; padding: 10px;">
                                <!-- MvCamera设置 (相机1/2) -->
                                <el-form v-if="selectedCamera === 1 || selectedCamera === 2" size="mini" label-width="80px">
                                    <el-form-item label="曝光时间">
                                        <el-input-number v-model="currentCamSettings.exposureTime" :min="10" :step="100" controls-position="right" style="width: 100%" @change="updateCameraParam('exposureTime')"></el-input-number>
                                    </el-form-item>
                                    <el-form-item label="帧率">
                                        <el-input-number v-model="currentCamSettings.frameRate" :min="1" :max="60" controls-position="right" style="width: 100%" @change="updateCameraParam('frameRate')"></el-input-number>
                                    </el-form-item>
                                    <el-form-item label="增益">
                                        <el-input-number v-model="currentCamSettings.gain" :min="0" :max="20" :step="0.1" controls-position="right" style="width: 100%" @change="updateCameraParam('gain')"></el-input-number>
                                    </el-form-item>
                                    <el-form-item label="黑白阈值">
                                        <el-input-number v-model="currentCamSettings.threshold" :min="0" :max="255" controls-position="right" style="width: 100%" @change="updateCameraParam('threshold')"></el-input-number>
                                    </el-form-item>
                                    <el-form-item>
                                        <el-button type="text" style="width: 100%; text-align: center;" @click="openAdvancedSettings">其他设置</el-button>
                                    </el-form-item>
                                </el-form>
                                <!-- SDI相机设置 (相机3) -->
                                <el-form v-else-if="selectedCamera === 3" size="mini" label-width="80px">
                                    <el-form-item label="亮度">
                                        <el-input-number v-model="sdiParams.brightness" :min="0" :max="255" controls-position="right" style="width: 100%" @change="updateSDIParam('brightness')"></el-input-number>
                                    </el-form-item>
                                    <el-form-item label="对比度">
                                        <el-input-number v-model="sdiParams.contrast" :min="0" :max="255" controls-position="right" style="width: 100%" @change="updateSDIParam('contrast')"></el-input-number>
                                    </el-form-item>
                                    <el-form-item label="饱和度">
                                        <el-input-number v-model="sdiParams.saturation" :min="0" :max="255" controls-position="right" style="width: 100%" @change="updateSDIParam('saturation')"></el-input-number>
                                    </el-form-item>
                                    <el-form-item label="色调">
                                        <el-input-number v-model="sdiParams.hue" :min="-128" :max="127" controls-position="right" style="width: 100%" @change="updateSDIParam('hue')"></el-input-number>
                                    </el-form-item>
                                    <el-form-item label="黑白阈值">
                                        <el-input-number v-model="sdiParams.threshold" :min="0" :max="255" controls-position="right" style="width: 100%" @change="updateSDIParam('threshold')"></el-input-number>
                                    </el-form-item>
                                    <el-form-item>
                                        <el-button type="text" style="width: 100%; text-align: center;" @click="openAdvancedSettings">其他设置</el-button>
                                    </el-form-item>
                                </el-form>
                            </el-dropdown-menu>
                        </el-dropdown>
                        <el-switch v-model="cameraEnabled" size="mini" active-text="开" inactive-text="关"></el-switch>
                    </div>
                </div>
                <div class="panel__bd panel__bd--cam">
                    <div class="cam-viewport">
                        <canvas
                            ref="cameraCanvas"
                            class="cam-viewport__media"
                            v-show="cameraEnabled"
                            :style="{ cursor: isZoomMode ? 'crosshair' : 'default' }"
                            @mousedown="onMouseDown"
                            @mousemove="onMouseMove"
                            @mouseup="onMouseUp"
                            @mouseleave="onMouseUp"
                        ></canvas>
                        <div v-if="!cameraEnabled" class="cam-viewport__placeholder">
                            <span>相机已关闭</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 右侧通高：待补充 -->
            <div class="panel area-side">
                <div class="panel__hd">人机交互区</div>
                <div class="panel__bd">
                    <div class="stage-item" :class="{ 'stage-item--active': activeStageIndex === 0 }">
                        <div class="stage-item__title"><b>粗调对准</b></div>
                        <div class="stage-item__desc">对应步骤：粗调对准</div>
                    <div class="toolbar">
                        <div>指示激光器控制：</div>
                        <el-button size="mini" :type="laserOn ? 'success' : 'default'" @click="toggleLaser">{{ laserOn ? '已打开' : '已关闭' }}</el-button>
                        <div style="width:220px;">
                            <el-slider v-model="laserPower" :min="0" :max="100" :step="1" show-input input-size="mini" :disabled="!laserOn" @change="updateLaserPower"></el-slider>
                        </div>
                        <el-button size="mini" type="primary" @click="setLaserHorizontal" >水平到位</el-button>
                        <el-button size="mini" type="primary" @click="setLaserRotation" >旋转到位</el-button>
                    </div>
                    </div>
                    <div class="stage-item" :class="{ 'stage-item--active': activeStageIndex === 1 }">
                        <div class="stage-item__title"><b>基准/测试光轴</b></div>
                        <div class="stage-item__desc">对应步骤：基准光轴、测试光轴</div>
                        <div class="toolbar">
                            <div>可见光源控制：</div>
                            <el-button size="mini" :type="visibleLightOn ? 'success' : 'default'" @click="toggleVisibleLight">{{ visibleLightOn ? '已打开' : '已关闭' }}</el-button>
                            <div style="width:220px;">
                                <el-slider v-model="visibleLightPower" :min="0" :max="100" :step="1" show-input input-size="mini" :disabled="!visibleLightOn" @change="updateVisibleLightPower"></el-slider>
                            </div>
                            <el-button size="mini" type="primary" @click="setTargetHorizontal">靶标水平到位</el-button>
                            <el-button size="mini" type="primary" @click="setTargetHorizontalZero">靶标水平归零</el-button>
                        </div>
                        <div class="toolbar">
                            <div>红外黑体控制：</div>
                            <el-button size="mini" :type="blackbodyOn ? 'success' : 'default'" @click="toggleBlackbody">{{ blackbodyOn ? '已打开' : '已关闭' }}</el-button>
                            <div style="width:220px;">
                                <el-slider v-model="blackbodyTemperature" :min="0" :max="100" :step="1" show-input input-size="mini" :disabled="!blackbodyOn" @change="updateBlackbodyTemperature"></el-slider>
                            </div>
                            <el-button size="mini" type="primary" @click="setTargetRotation" :disabled="true">靶标旋转到位</el-button>
                            <el-button size="mini" type="primary" @click="setTargetRotationZero">靶标旋转归零</el-button>
                        </div>
                        <div class="toolbar">靶标选择：</div>
                        <div class="toolbar">
                            <el-button
                                v-for="(item, index) in targetConfig"
                                :key="index"
                                size="mini"
                                type="primary"
                                @click="setTarget(item.value, item.lable)">
                                {{ item.label }}
                            </el-button>
                        </div>
                        <div class="toolbar">靶标位置微调：</div>
                        <div class="toolbar">
                            <div>水平移动：</div>
                            <el-input-number v-model="fineMoveX" :min="-999" :max="999" :step="100" size="mini"></el-input-number>
                            <el-button size="mini" icon="el-icon-caret-right" @click="nudgeHorizontal">微调</el-button>
                            <div style="width:12px;"></div>
                            <div>靶轮旋转：</div>
                            <el-input-number v-model="fineRotate" :min="-999" :max="999" :step="100" size="mini"></el-input-number>
                            <el-button size="mini" icon="el-icon-refresh" @click="nudgeRotation">微调</el-button>
                        </div>
                    </div>
                    <div class="stage-item stage-item--result" :class="{ 'stage-item--active': activeStageIndex === 2 }">
                        <div class="stage-item__title"><b>测试结果</b></div>
                        <div class="stage-item__desc">对应步骤：测试结果</div>
                        <div class="toolbar">
                            <div>基准光轴参数：</div>
                            <div>像元大小：<span :class="basePixelSize > 0 ? 'text-value' : 'text-placeholder'">{{ basePixelSize }}</span> μm</div>
                            <div style="width:12px;"></div>
                            <div>焦距：<span :class="baseFocalLength > 0 ? 'text-value' : 'text-placeholder'">{{ baseFocalLength }}</span> mm</div>
                        </div>
                        <div class="toolbar">
                            <div>基准光轴偏移：</div>
                            <div>像素(px)：
                                <span :class="baseOffsetPx.x != -1 ? 'text-value' : 'text-placeholder'">
                                    X={{ baseOffsetPx.x }}, Y={{ baseOffsetPx.y }}
                                </span>
                            </div>
                            <div style="width:12px;"></div>
                            <div>角度(°)：
                                <span :class="baseOffsetPx.x != -1 ? 'text-value' : 'text-placeholder'">
                                    X={{ angleXText }}, Y={{ angleYText }}
                                </span>
                            </div>
                        </div>
                        <div class="toolbar">
                            <div>测试光轴参数：</div>
                            <div>像元大小：<span :class="testPixelSize > 0 ? 'text-value' : 'text-placeholder'">{{ testPixelSize }}</span> μm</div>
                            <div style="width:12px;"></div>
                            <div>焦距：<span :class="testFocalLength > 0 ? 'text-value' : 'text-placeholder'">{{ testFocalLength }}</span> mm</div>
                        </div>
                        <div class="toolbar">
                            <div>测试光轴偏移：</div>
                            <div>像素(px)：
                                <span :class="currentStep === 4 ? 'text-highlight-red' : (testOffsetPx.x != -1 ? 'text-value' : 'text-placeholder')">
                                    X={{ testOffsetPx.x }}, Y={{ testOffsetPx.y }}
                                </span>
                            </div>
                            <div style="width:12px;"></div>
                            <div>角度(°)：
                                <span :class="currentStep === 4 ? 'text-highlight-red' : (testOffsetPx.x != -1 ? 'text-value' : 'text-placeholder')">
                                    X={{ testAngleXText }}, Y={{ testAngleYText }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 下方：位于左下方，形成 L 形 -->
            <div class="panel area-bottom">
                <div class="panel__hd">图像信息显示区</div>
                <div class="panel__bd">
                    <el-descriptions size="small" :column="4" border>
                        <el-descriptions-item label="宽度(px)">{{ imageInfo.width != null ? imageInfo.width : '-' }}</el-descriptions-item>
                        <el-descriptions-item label="高度(px)">{{ imageInfo.height != null ? imageInfo.height : '-' }}</el-descriptions-item>
                        <el-descriptions-item label="质心 X(px)">{{ imageInfo.centroidX != null ? imageInfo.centroidX : '-' }}</el-descriptions-item>
                        <el-descriptions-item label="质心 Y(px)">{{ imageInfo.centroidY != null ? imageInfo.centroidY : '-' }}</el-descriptions-item>
                    </el-descriptions>
                </div>
            </div>
        </div>
    </div>

    <el-dialog 
        :title="dialogTitle" 
        :visible.sync="paramDialogVisible" 
        width="400px" 
        :close-on-click-modal="false">
        <el-form label-width="120px">
            <el-form-item label="像元大小 (μm)">
                <el-input-number v-model="inputParams.pixelSize" :min="0.1" :step="0.1" size="small"></el-input-number>
            </el-form-item>
            <el-form-item label="焦距 (mm)">
                <el-input-number v-model="inputParams.focalLength" :min="1" :step="1" size="small"></el-input-number>
            </el-form-item>
            <el-form-item label="当前质心">
                <span>X: {{ imageInfo.centroidX || '未检测' }}, Y: {{ imageInfo.centroidY || '未检测' }}</span>
            </el-form-item>
            <div style="color: #909399; font-size: 12px; line-height: 1.5;">
                点击确定后，将使用当前相机画面的质心坐标作为<br>
                <b>{{ currentDialogStage === 'base' ? '基准' : '测试' }}光轴</b> 的偏移计算依据。
            </div>
        </el-form>
        <span slot="footer" class="dialog-footer">
            <el-button @click="paramDialogVisible = false">取 消</el-button>
            <el-button type="primary" @click="confirmParams">确 定</el-button>
        </span>
    </el-dialog>
    <el-dialog title="高级相机设置" :visible.sync="advancedSettingVisible" width="800px" :close-on-click-modal="false">
        <el-tabs type="border-card">
            <!-- 配置保存标签页 -->
            <el-tab-pane label="默认配置">
                <el-tabs type="card">
                    <el-tab-pane
                        v-for="(camConfig, index) in cameraConfigs"
                        :key="camConfig.id"
                        :label="camConfig.name || ('相机 ' + camConfig.id)">

                        <el-form :model="camConfig" label-width="100px" size="small">
                            <el-form-item label="相机名称">
                                <el-input v-model="camConfig.name"></el-input>
                            </el-form-item>
                            <el-form-item label="IP 地址" v-if="camConfig.type === 'mvcamera'">
                                <el-input v-model="camConfig.ip"></el-input>
                            </el-form-item>

                            <!-- MvCamera参数 (相机1/2) -->
                            <template v-if="camConfig.type === 'mvcamera'">
                                <el-divider content-position="left">默认参数</el-divider>
                                <el-row :gutter="20">
                                    <el-col :span="6">
                                        <el-form-item label="曝光" label-width="50px">
                                            <el-input-number v-model="camConfig.exposureTime" :controls="false" style="width:100%"></el-input-number>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="6">
                                        <el-form-item label="帧率" label-width="50px">
                                            <el-input-number v-model="camConfig.frameRate" :controls="false" style="width:100%"></el-input-number>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="6">
                                        <el-form-item label="增益" label-width="50px">
                                            <el-input-number v-model="camConfig.gain" :controls="false" style="width:100%"></el-input-number>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="6">
                                        <el-form-item label="阈值" label-width="50px">
                                            <el-input-number v-model="camConfig.threshold" :controls="false" style="width:100%"></el-input-number>
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                            </template>

                            <!-- SDI参数 (相机3) -->
                            <template v-else-if="camConfig.type === 'sdi'">
                                <el-divider content-position="left">SDI参数</el-divider>
                                <el-row :gutter="20">
                                    <el-col :span="6">
                                        <el-form-item label="亮度" label-width="50px">
                                            <el-input-number v-model="camConfig.brightness" :controls="false" style="width:100%"></el-input-number>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="6">
                                        <el-form-item label="对比度" label-width="50px">
                                            <el-input-number v-model="camConfig.contrast" :controls="false" style="width:100%"></el-input-number>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="6">
                                        <el-form-item label="饱和度" label-width="50px">
                                            <el-input-number v-model="camConfig.saturation" :controls="false" style="width:100%"></el-input-number>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="6">
                                        <el-form-item label="色调" label-width="50px">
                                            <el-input-number v-model="camConfig.hue" :min="-128" :max="127" :controls="false" style="width:100%"></el-input-number>
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                                <el-row :gutter="20">
                                    <el-col :span="6">
                                        <el-form-item label="阈值" label-width="50px">
                                            <el-input-number v-model="camConfig.threshold" :controls="false" style="width:100%"></el-input-number>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="6">
                                        <el-form-item label="通道" label-width="50px">
                                            <el-input-number v-model="camConfig.sdiChannel" :min="0" :controls="false" style="width:100%"></el-input-number>
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                            </template>

                            <!-- 虚拟相机参数 (相机4) -->
                            <template v-else-if="camConfig.type === 'virtual'">
                                <el-divider content-position="left">参数</el-divider>
                                <el-row :gutter="20">
                                    <el-col :span="6">
                                        <el-form-item label="阈值" label-width="50px">
                                            <el-input-number v-model="camConfig.threshold" :controls="false" style="width:100%"></el-input-number>
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                                <el-alert title="虚拟相机用于静态图像分析，无需其他参数" type="info" :closable="false"></el-alert>
                            </template>
                        </el-form>
                    </el-tab-pane>
                </el-tabs>
            </el-tab-pane>

            <!-- 实时参数调整标签页（仅当相机连接时可用，虚拟相机不可用） -->
            <el-tab-pane label="实时参数" :disabled="!isConnected || cameraType === 'virtual'">
                <el-alert
                    v-if="!isConnected"
                    title="请先连接相机"
                    type="warning"
                    :closable="false"
                    show-icon>
                </el-alert>
                <el-alert
                    v-else-if="cameraType === 'virtual'"
                    title="虚拟相机不支持实时参数"
                    type="info"
                    :closable="false"
                    show-icon>
                </el-alert>

                <!-- SDI相机实时参数 -->
                <el-form v-else-if="cameraType === 'sdi'" label-width="100px" size="small">
                    <el-divider content-position="left">SDI视频参数</el-divider>
                    <el-row :gutter="20">
                        <el-col :span="6">
                            <el-form-item label="亮度">
                                <el-input-number v-model="sdiParams.brightness" :min="0" :max="255" controls-position="right" style="width:100%" @change="updateSDIParam('brightness')"></el-input-number>
                            </el-form-item>
                        </el-col>
                        <el-col :span="6">
                            <el-form-item label="对比度">
                                <el-input-number v-model="sdiParams.contrast" :min="0" :max="255" controls-position="right" style="width:100%" @change="updateSDIParam('contrast')"></el-input-number>
                            </el-form-item>
                        </el-col>
                        <el-col :span="6">
                            <el-form-item label="饱和度">
                                <el-input-number v-model="sdiParams.saturation" :min="0" :max="255" controls-position="right" style="width:100%" @change="updateSDIParam('saturation')"></el-input-number>
                            </el-form-item>
                        </el-col>
                        <el-col :span="6">
                            <el-form-item label="色调">
                                <el-input-number v-model="sdiParams.hue" :min="-128" :max="127" controls-position="right" style="width:100%" @change="updateSDIParam('hue')"></el-input-number>
                            </el-form-item>
                        </el-col>
                    </el-row>
                    <el-row :gutter="20">
                        <el-col :span="6">
                            <el-form-item label="二值化阈值">
                                <el-input-number v-model="sdiParams.threshold" :min="0" :max="255" controls-position="right" style="width:100%" @change="updateSDIParam('threshold')"></el-input-number>
                            </el-form-item>
                        </el-col>
                    </el-row>
                    <el-divider></el-divider>
                    <el-button type="success" icon="el-icon-refresh" @click="syncSDISettings">刷新参数</el-button>
                </el-form>

                <!-- MvCamera实时参数 -->
                <el-form v-else label-width="100px" size="small">
                    <!-- 基础参数 -->
                    <el-divider content-position="left">基础参数</el-divider>
                    <el-row :gutter="20">
                        <el-col :span="8">
                            <el-form-item label="曝光时间">
                                <el-input-number v-model="liveParams.exposureTime" :min="10" :step="100" controls-position="right" style="width:100%" @change="setLiveParam('exposureTime')"></el-input-number>
                            </el-form-item>
                        </el-col>
                        <el-col :span="8">
                            <el-form-item label="帧率">
                                <el-input-number v-model="liveParams.frameRate" :min="1" :max="60" controls-position="right" style="width:100%" @change="setLiveParam('frameRate')"></el-input-number>
                            </el-form-item>
                        </el-col>
                        <el-col :span="8">
                            <el-form-item label="增益">
                                <el-input-number v-model="liveParams.gain" :min="0" :max="20" :step="0.1" :precision="1" controls-position="right" style="width:100%" @change="setLiveParam('gain')"></el-input-number>
                            </el-form-item>
                        </el-col>
                    </el-row>

                    <!-- 图像尺寸 -->
                    <el-divider content-position="left">图像尺寸 (ROI)</el-divider>
                    <el-row :gutter="20">
                        <el-col :span="6">
                            <el-form-item label="宽度">
                                <el-input-number v-model="liveParams.width" :min="32" :step="16" controls-position="right" style="width:100%" @change="setLiveParam('width')"></el-input-number>
                            </el-form-item>
                        </el-col>
                        <el-col :span="6">
                            <el-form-item label="高度">
                                <el-input-number v-model="liveParams.height" :min="32" :step="16" controls-position="right" style="width:100%" @change="setLiveParam('height')"></el-input-number>
                            </el-form-item>
                        </el-col>
                        <el-col :span="6">
                            <el-form-item label="X偏移">
                                <el-input-number v-model="liveParams.offsetX" :min="0" :step="16" controls-position="right" style="width:100%" @change="setLiveParam('offsetX')"></el-input-number>
                            </el-form-item>
                        </el-col>
                        <el-col :span="6">
                            <el-form-item label="Y偏移">
                                <el-input-number v-model="liveParams.offsetY" :min="0" :step="16" controls-position="right" style="width:100%" @change="setLiveParam('offsetY')"></el-input-number>
                            </el-form-item>
                        </el-col>
                    </el-row>

                    <!-- 图像处理 -->
                    <el-divider content-position="left">图像处理</el-divider>
                    <el-row :gutter="20">
                        <el-col :span="8">
                            <el-form-item label="Gamma">
                                <el-input-number v-model="liveParams.gamma" :min="0.1" :max="4.0" :step="0.1" :precision="2" controls-position="right" style="width:100%" @change="setLiveParam('gamma')"></el-input-number>
                            </el-form-item>
                        </el-col>
                        <el-col :span="8">
                            <el-form-item label="黑电平">
                                <el-input-number v-model="liveParams.blackLevel" :min="0" :max="255" :step="1" controls-position="right" style="width:100%" @change="setLiveParam('blackLevel')"></el-input-number>
                            </el-form-item>
                        </el-col>
                        <el-col :span="8">
                            <el-form-item label="二值化阈值">
                                <el-input-number v-model="liveParams.threshold" :min="0" :max="255" :step="1" controls-position="right" style="width:100%" @change="setLiveParam('threshold')"></el-input-number>
                            </el-form-item>
                        </el-col>
                    </el-row>
                    <el-row :gutter="20">
                        <el-col :span="8">
                            <el-form-item label="X镜像">
                                <el-switch v-model="liveParams.reverseX" @change="setLiveParam('reverseX')"></el-switch>
                            </el-form-item>
                        </el-col>
                        <el-col :span="8">
                            <el-form-item label="Y镜像">
                                <el-switch v-model="liveParams.reverseY" @change="setLiveParam('reverseY')"></el-switch>
                            </el-form-item>
                        </el-col>
                    </el-row>

                    <!-- 自动控制 -->
                    <el-divider content-position="left">自动控制</el-divider>
                    <el-row :gutter="20">
                        <el-col :span="8">
                            <el-form-item label="自动曝光">
                                <el-select v-model="liveParams.exposureAuto" style="width:100%" @change="setLiveParam('exposureAuto')">
                                    <el-option label="关闭" :value="0"></el-option>
                                    <el-option label="单次" :value="1"></el-option>
                                    <el-option label="连续" :value="2"></el-option>
                                </el-select>
                            </el-form-item>
                        </el-col>
                        <el-col :span="8">
                            <el-form-item label="自动增益">
                                <el-select v-model="liveParams.gainAuto" style="width:100%" @change="setLiveParam('gainAuto')">
                                    <el-option label="关闭" :value="0"></el-option>
                                    <el-option label="单次" :value="1"></el-option>
                                    <el-option label="连续" :value="2"></el-option>
                                </el-select>
                            </el-form-item>
                        </el-col>
                    </el-row>

                    <!-- 触发控制 -->
                    <el-divider content-position="left">触发控制</el-divider>
                    <el-row :gutter="20">
                        <el-col :span="8">
                            <el-form-item label="触发模式">
                                <el-select v-model="liveParams.triggerMode" style="width:100%" @change="setLiveParam('triggerMode')">
                                    <el-option label="关闭 (连续采集)" :value="0"></el-option>
                                    <el-option label="开启 (触发采集)" :value="1"></el-option>
                                </el-select>
                            </el-form-item>
                        </el-col>
                        <el-col :span="8">
                            <el-form-item label="触发源">
                                <el-select v-model="liveParams.triggerSource" style="width:100%" @change="setLiveParam('triggerSource')" :disabled="liveParams.triggerMode === 0">
                                    <el-option label="Line0" :value="0"></el-option>
                                    <el-option label="Line1" :value="1"></el-option>
                                    <el-option label="软触发" :value="7"></el-option>
                                </el-select>
                            </el-form-item>
                        </el-col>
                        <el-col :span="8">
                            <el-form-item label="软触发">
                                <el-button type="primary" size="small" @click="executeSoftwareTrigger" :disabled="liveParams.triggerMode === 0 || liveParams.triggerSource !== 7">执行软触发</el-button>
                            </el-form-item>
                        </el-col>
                    </el-row>

                    <!-- 操作按钮 -->
                    <el-divider></el-divider>
                    <el-row :gutter="20">
                        <el-col :span="12">
                            <el-button type="success" icon="el-icon-refresh" @click="refreshLiveParams" style="width:100%">刷新参数</el-button>
                        </el-col>
                        <el-col :span="12">
                            <el-button type="warning" icon="el-icon-download" @click="applyConfigToLive" style="width:100%">应用默认配置</el-button>
                        </el-col>
                    </el-row>
                </el-form>
            </el-tab-pane>
        </el-tabs>
        <span slot="footer" class="dialog-footer">
            <el-button @click="advancedSettingVisible = false">取 消</el-button>
            <el-button type="primary" @click="saveAdvancedSettings">保存配置</el-button>
        </span>
    </el-dialog>
</div>

<script>
var vm = new Vue({
    el: '#app',
    data: {
        // 测试箱相机相关变量
        socket: null,
        isConnected: false,
        isVirtualCamera: false,  // 是否为虚拟相机(静态图像上传)
        cameraType: 'mvcamera',  // 相机类型: 'mvcamera', 'sdi', 'virtual'
        ctx: null,
        canvas: null,
        drawCentroid: false,
        drawCross: true,
        showOriginal: true,
        imageInfo: {
            width: null,
            height: null,
            centroidX: null,
            centroidY: null
        },
        // 进度条
        steps: [
            { key: 'prepare', title: '测试说明' },
            { key: 'coarse',  title: '粗调对准' },
            { key: 'fine',    title: '基准光轴' },
            { key: 'verify',  title: '测试光轴' },
            { key: 'result',  title: '测试结果'}
        ],
        currentStep: 0,
        // 相机相关
        camera3Source: '/static/images/test_image.jpg',
        cameraEnabled: false,
        selectedCamera: 1,
        cameraList: [],
        // 指示激光控制
        laserOn: false,
        laserPower: 15,
        visibleLightOn: false,
        visibleLightPower: 15,
        blackbodyOn: false,
        blackbodyTemperature: 15,
        // 微调
        fineMoveX: 0,
        fineRotate: 0,
        // 靶标旋转位置
        targetConfig :[
            { label: '四杆',       value: 1004},
            { label: 'USAF',       value: 5000},
            { label: '十字',       value: 12540},
            { label: '指示激光',   value: 8624 },
            { label: '4mm星点',    value: 16375},
            { label: '0.5mm星点',  value: 20200},
            { label: '0.2mm星点',  value: 24016},
            { label: '0.1mm星点',  value: 27842}
        ],
        // 基准光轴参数
        basePixelSize: 0.00,
        baseFocalLength: 0.0,
        // 基准光轴偏移（由后端相机提供像素偏移）
        baseOffsetPx: { x: -1, y: -1 },
        // 测试光轴参数/偏移
        testPixelSize: 0.00,
        testFocalLength: 0.0,
        testOffsetPx: { x: -1, y: -1 },
        paramDialogVisible: false,
        currentDialogStage: 'base',
        inputParams:{
            pixelSize: -1,
            focalLength: -1
        },
        // 相机设置
        advancedSettingVisible: false,
        cameraConfigs: [
            { id: 1, name: '相机1', ip: '', exposureTime: 5000, frameRate: 1, gain: 0, threshold: 128 },
            { id: 2, name: '相机2', ip: '', exposureTime: 5000, frameRate: 1, gain: 0, threshold: 128 }
        ],
        currentCamSettings: {
            exposureTime: 5000,
            frameRate: 30,
            gain: 0,
            threshold: 128
        },
        // 实时参数（高级设置用 - MvCamera）
        liveParams: {
            // 基础参数
            exposureTime: 5000,
            frameRate: 10,
            gain: 0,
            threshold: 128,
            // 图像尺寸
            width: 1280,
            height: 1024,
            offsetX: 0,
            offsetY: 0,
            // 图像处理
            gamma: 1.0,
            blackLevel: 0,
            reverseX: false,
            reverseY: false,
            // 自动控制
            exposureAuto: 0,
            gainAuto: 0,
            // 触发控制
            triggerMode: 0,
            triggerSource: 7
        },
        // SDI相机参数（相机3）
        sdiParams: {
            threshold: 128,
            brightness: 136,
            contrast: 146,
            saturation: 136,
            hue: 0
        },
        // 图像显示缩放
        isZoomMode: false,
        viewRect: null,
        isSelecting: false,
        selectionStart: {x:0, y:0},
        selectionCurrent: {x:0, y:0}
    },
    computed: {
        activeStageIndex(){
            // 将顶部的 5 个步骤映射为侧栏的 3 个阶段
            // 0: 粗调对准 (coarse)
            // 1: 基准/测试光轴 (fine, verify)
            // 2: 测试结果 (result)
            const idx = this.currentStep;
            if(idx <= 1){ // prepare(0) & coarse(1) => 高亮到粗调
                return 0;
            } else if(idx === 2 || idx === 3){ // fine(2), verify(3)
                return 1;
            } else { // result(4)
                return 2;
            }
        },
        // X/Y 方向角度（度）。像素转毫米：pixel * (μm/1000) -> mm；角度 = atan(mm / 焦距mm)
        angleXDeg(){
            const pxSizeUm = Number(this.basePixelSize) || 0;
            const fMm = Number(this.baseFocalLength) || 0;
            if(pxSizeUm <= 0 || fMm <= 0) return 0;
            const dxMm = (Number(this.baseOffsetPx.x) || 0) * pxSizeUm / 1000.0;
            return Math.atan(dxMm / fMm) * 180 / Math.PI;
        },
        angleYDeg(){
            const pxSizeUm = Number(this.basePixelSize) || 0;
            const fMm = Number(this.baseFocalLength) || 0;
            if(pxSizeUm <= 0 || fMm <= 0) return 0;
            const dyMm = (Number(this.baseOffsetPx.y) || 0) * pxSizeUm / 1000.0;
            return Math.atan(dyMm / fMm) * 180 / Math.PI;
        },
        angleXText(){ return this.angleXDeg.toFixed(3); },
        angleYText(){ return this.angleYDeg.toFixed(3); },
        // 测试光轴角度文本
        testAngleXDeg(){
            const pxSizeUm = Number(this.testPixelSize) || 0;
            const fMm = Number(this.testFocalLength) || 0;
            if(pxSizeUm <= 0 || fMm <= 0) return 0;
            const dxMm = (Number(this.testOffsetPx.x) || 0) * pxSizeUm / 1000.0;
            return Math.atan(dxMm / fMm) * 180 / Math.PI;
        },
        testAngleYDeg(){
            const pxSizeUm = Number(this.testPixelSize) || 0;
            const fMm = Number(this.testFocalLength) || 0;
            if(pxSizeUm <= 0 || fMm <= 0) return 0;
            const dyMm = (Number(this.testOffsetPx.y) || 0) * pxSizeUm / 1000.0;
            return Math.atan(dyMm / fMm) * 180 / Math.PI;
        },
        testAngleXText(){ return this.testAngleXDeg.toFixed(3); },
        testAngleYText(){ return this.testAngleYDeg.toFixed(3); },
        dialogTitle(){
            return this.currentDialogStage === 'base' ? '录入基准光轴参数' : '录入测试光轴参数';
        }
    },
    watch:{
        // 下拉框拉开自动断旧相机
        selectedCamera(newVal, oldVal) {
            if (this.cameraEnabled) {
                if(oldVal) this.disconnectCamera(oldVal); // 传入旧值以断开特定ID
                this.$nextTick(() => {
                    this.connectCamera();
                });
            }
        },
        // 监听开关
        cameraEnabled(newVal) {
            if (newVal) {
                this.connectCamera();
            } else {
                this.disconnectCamera(this.selectedCamera);
            }
        },
        selectedCamera(newVal, oldVal) {
            this.syncCurrentCamSettings(); // 【新增】切换相机时同步设置值
            
            if (this.cameraEnabled) {
                if(oldVal) this.disconnectCamera(oldVal);
                this.$nextTick(() => { this.connectCamera(); });
            }
        },
        showOriginal(newVal) {
            if (this.isConnected) {
                // 如果勾选(true)，发 0 (原图)；如果取消勾选(false)，发 1 (二值化)
                // 或者反过来，看你的习惯。
                // 这里假设：勾选=看原图(value=0)，不勾选=看二值化(value=1)
                const valToSend = newVal ? 0 : 1;
                
                const camId = this.getCameraIntId(this.selectedCamera);
                this.socket.emit('camera_set_param', {
                    cameraId: camId,
                    type: 'imageMode',
                    value: valToSend
                });
            }
        },
    },
    methods: {
        nextStep(){
            if(this.currentStep === 2){
                this.openParamDialog('base');
                return;
            }
            if(this.currentStep === 3){
                this.openParamDialog('test');
                return;
            }
            if(this.currentStep === this.steps.length - 1){
                this.resetAllData();
                return;
            }
            if(this.currentStep < this.steps.length - 1){
                this.currentStep += 1; 
            } 
        },
        prevStep(){ if(this.currentStep > 0){ this.currentStep -= 1; } },
        openParamDialog(stage){
            this.currentDialogStage = stage;
            this.paramDialogVisible = true;
        },
        confirmParams(){
            const cx = Number(this.imageInfo.centroidX);
            const cy = Number(this.imageInfo.centroidY);
            const w = Number(this.imageInfo.width);
            const h = Number(this.imageInfo.height);

            if(isNaN(cx) || isNaN(cy) || cx<=0 || cy<=0){
                this.$confirm("当前为检测到有效的质心数据，记录为100", "提示", {
                    confirmButtonTest: "好的",
                    type: 'warnig'
                }).then(()=>{
                    this.saveAndProceed(100, 100);
                }).catch(()=>{});
                return;
            }
            const offsetX = cx - (w/2);
            const offsetY = cy - (h/2);
            this.saveAndProceed(offsetX, offsetY);
        },
        saveAndProceed(offsetX, offsetY) {
            // 保存弹窗数据
            if (this.currentDialogStage === 'base') {
                this.basePixelSize = this.inputParams.pixelSize;
                this.baseFocalLength = this.inputParams.focalLength;
                this.baseOffsetPx = { x: offsetX.toFixed(2), y: offsetY.toFixed(2) };
                this.$message.success('基准光轴数据已记录');
            } else {
                this.testPixelSize = this.inputParams.pixelSize;
                this.testFocalLength = this.inputParams.focalLength;
                this.testOffsetPx = { x: offsetX.toFixed(2), y: offsetY.toFixed(2) };
                this.$message.success('测试光轴数据已记录');
            }

            // 关闭弹窗并跳转
            this.paramDialogVisible = false;
            this.currentStep += 1;
        },
        calcAngle(pxSize, fLen, offsetPx) {
            const p = Number(pxSize) || 0;
            const f = Number(fLen) || 0;
            const off = Number(offsetPx) || 0;
            if (p <= 0 || f <= 0) return 0;
            
            // 计算角度公式
            const dMm = off * (p / 1000.0);
            return Math.atan(dMm / f) * 180 / Math.PI;
        },
        resetAllData(){
            this.$confirm('确定要清空数据并重新开始测试吗？', '重开测试', {
                confirmButtonText: '确定',
                cancelButtonText: '取消',
                type: 'warning'
            }).then(() => {
                // 1. 重置步骤
                this.currentStep = 0;
                
                // 2. 重置结果数据
                this.basePixelSize = 0.00;
                this.baseFocalLength = 0.0;
                this.baseOffsetPx = { x: -1, y: -1 };
                
                this.testPixelSize = 0.00;
                this.testFocalLength = 0.0;
                this.testOffsetPx = { x: -1, y: -1 };
                
                // 3. (可选) 重置微调数据或输入框缓存
                this.fineMoveX = 0;
                this.fineRotate = 0;
                this.inputParams = { pixelSize: -1, focalLength: -1 };

                this.$message.success('已重置，请开始新一轮测试');
            }).catch(() => {});
        },
        loadCameraConfig(callback) {
            axios.get('/api/camera-config').then(res => {
                if (res.data.success) {
                    this.cameraConfigs = res.data.data.cameras;
                    const dynamicList = this.cameraConfigs.map(cam=>({
                        label: cam.name || `相机 ${cam.id}`,
                        value: cam.id
                    }));
                    this.cameraList = dynamicList;

                    if(callback){
                        callback();
                    }
                }
            });
        },
        syncCurrentCamSettings() {
            const camId = this.getCameraIntId(this.selectedCamera);
            if (camId === 3) return; // 相机3不需要配置

            const config = this.cameraConfigs.find(c => c.id === camId);
            if (config) {
                // 浅拷贝，避免直接修改 config
                this.currentCamSettings = { ...config };
            }
        },
        openAdvancedSettings() {
            // 重新加载一次最新配置，防止未同步
            this.loadCameraConfig();
            this.advancedSettingVisible = true;

            // 如果已连接真实相机，自动刷新实时参数
            if (this.isConnected && !this.isVirtualCamera) {
                this.$nextTick(() => {
                    this.refreshLiveParams();
                });
            }
        },
        saveAdvancedSettings() {
            const payload = { cameras: this.cameraConfigs };
            axios.post('/api/camera-config', payload).then(res => {
                if (res.data.success) {
                    this.$message.success('相机配置保存成功');
                    this.advancedSettingVisible = false;

                    this.loadCameraConfig(()=>{
                        this.syncCurrentCamSettings(); // 保存后更新当前面板
                        if(this.isConnected){
                            this.applyAllCameraParams(this.getCameraIntId(this.selectedCamera))
                        }
                    });
                } else {
                    this.$message.error('保存失败' +res.data.message || "未知错误");
                }
            });
        },
        updateCameraParam(type) {
            // 1. 发送指令给MvCamera硬件（相机1/2）
            if (this.isConnected) {
                const val = this.currentCamSettings[type];
                const camId = this.getCameraIntId(this.selectedCamera);
                // 只有MvCamera相机发送参数
                if(camId === 1 || camId === 2){
                    console.log(`发送参数设置: ID=${camId}, Type=${type}, Val=${val}`);
                    this.socket.emit('camera_set_param',{
                        cameraId: camId,
                        type: type,
                        value: val
                    });
                }
            }
        },
        // SDI相机参数设置
        updateSDIParam(type) {
            if (!this.isConnected || this.cameraType !== 'sdi') return;

            const val = this.sdiParams[type];
            const camId = 3;

            console.log(`发送SDI参数设置: ID=${camId}, Type=${type}, Val=${val}`);
            this.socket.emit('camera_set_param', {
                cameraId: camId,
                type: type,
                value: val
            });
        },
        // 同步SDI设置
        syncSDISettings() {
            const config = this.cameraConfigs.find(c => c.id === 3);
            if (config) {
                this.sdiParams.threshold = config.threshold || 128;
                this.sdiParams.brightness = config.brightness || 136;
                this.sdiParams.contrast = config.contrast || 146;
                this.sdiParams.saturation = config.saturation || 136;
                this.sdiParams.hue = config.hue || 0;
            }
        },
        applyAllCameraParams(camId) {
            // 只对MvCamera相机应用（1和2）
            if (camId === 3 || camId === 4) return;
            const config = this.cameraConfigs.find(c => c.id === camId);
            if (!config) return;

            console.log(`正在应用相机 ${camId} 的所有初始化参数...`);
            // 依次发送参数设置指令
            ['exposureTime', 'frameRate', 'threshold', 'gain'].forEach(type => {
                if (config[type] !== undefined) {
                    this.socket.emit('camera_set_param', {
                        cameraId: camId,
                        type: type,
                        value: config[type]
                    });
                }
            });
        },
        // ===================== 高级参数方法 =====================
        // 设置实时参数（仅MvCamera）
        setLiveParam(type) {
            if (!this.isConnected || this.cameraType !== 'mvcamera') return;

            const val = this.liveParams[type];
            const camId = this.getCameraIntId(this.selectedCamera);

            console.log(`设置高级参数: ID=${camId}, Type=${type}, Val=${val}`);
            this.socket.emit('camera_set_param', {
                cameraId: camId,
                type: type,
                value: val
            });
        },
        // 从相机刷新所有参数（仅MvCamera）
        refreshLiveParams() {
            if (!this.isConnected || this.cameraType !== 'mvcamera') {
                this.$message.warning('请先连接MvCamera相机（相机1或2）');
                return;
            }

            const camId = this.getCameraIntId(this.selectedCamera);

            // 请求获取所有参数
            axios.post('/api/camera/all-params', { cameraId: camId })
                .then(res => {
                    if (res.data.success && res.data.params) {
                        const params = res.data.params;
                        // 更新本地参数
                        if (params.exposureTime !== undefined && params.exposureTime !== -1) this.liveParams.exposureTime = params.exposureTime;
                        if (params.frameRate !== undefined && params.frameRate !== -1) this.liveParams.frameRate = params.frameRate;
                        if (params.gain !== undefined && params.gain !== -1) this.liveParams.gain = params.gain;
                        if (params.threshold !== undefined) this.liveParams.threshold = params.threshold;
                        if (params.width !== undefined && params.width !== -1) this.liveParams.width = params.width;
                        if (params.height !== undefined && params.height !== -1) this.liveParams.height = params.height;
                        if (params.offsetX !== undefined && params.offsetX !== -1) this.liveParams.offsetX = params.offsetX;
                        if (params.offsetY !== undefined && params.offsetY !== -1) this.liveParams.offsetY = params.offsetY;
                        if (params.gamma !== undefined && params.gamma !== -1) this.liveParams.gamma = params.gamma;
                        if (params.blackLevel !== undefined && params.blackLevel !== -1) this.liveParams.blackLevel = params.blackLevel;
                        if (params.reverseX !== undefined) this.liveParams.reverseX = params.reverseX;
                        if (params.reverseY !== undefined) this.liveParams.reverseY = params.reverseY;
                        if (params.exposureAuto !== undefined && params.exposureAuto !== -1) this.liveParams.exposureAuto = params.exposureAuto;
                        if (params.gainAuto !== undefined && params.gainAuto !== -1) this.liveParams.gainAuto = params.gainAuto;
                        if (params.triggerMode !== undefined && params.triggerMode !== -1) this.liveParams.triggerMode = params.triggerMode;

                        this.$message.success('参数刷新成功');
                    } else {
                        this.$message.error(res.data.message || '获取参数失败');
                    }
                })
                .catch(err => {
                    this.$message.error('获取参数失败: ' + err.message);
                });
        },
        // 将保存的配置应用到实时相机
        applyConfigToLive() {
            if (!this.isConnected || this.isVirtualCamera) return;

            const camId = this.getCameraIntId(this.selectedCamera);
            const config = this.cameraConfigs.find(c => c.id === camId);
            if (!config) return;

            // 应用保存的配置
            ['exposureTime', 'frameRate', 'gain', 'threshold'].forEach(type => {
                if (config[type] !== undefined) {
                    this.liveParams[type] = config[type];
                    this.socket.emit('camera_set_param', {
                        cameraId: camId,
                        type: type,
                        value: config[type]
                    });
                }
            });

            this.$message.success('已应用默认配置');
        },
        // 执行软触发
        executeSoftwareTrigger() {
            if (!this.isConnected || this.isVirtualCamera) return;

            const camId = this.getCameraIntId(this.selectedCamera);
            this.socket.emit('camera_set_param', {
                cameraId: camId,
                type: 'softwareTrigger',
                value: 1
            });
        },
        // ===================== 高级参数方法结束 =====================
        getCameraIntId(camValue){
            // 从最开始的map，改为直接输出即可
            // return {'cam1' : 1, 'cam2' : 2, 'cam3' : 3}[camValue] || 1;
            return Number(camValue) || 1;
        },
        connectCamera(){
            if(!this.cameraEnabled) return;
            const camId = this.getCameraIntId(this.selectedCamera);

            console.log('正在请求连接相机 ID:', camId);
            if(!this.socket){
                this.$message.error('Socket 服务未连接');
                return;
            }

            // 所有相机（包括虚拟相机3）都通过SocketIO连接
            this.socket.emit('camera_connect', {cameraId: camId});
        },
        disconnectCamera(camValue){
            const camId = this.getCameraIntId(camValue || this.selectedCamera);

            if(this.socket){
                this.socket.emit('camera_disconnect',{cameraId: camId});
            }
            this.isConnected = false;
            this.isVirtualCamera = false;
            this.cameraType = 'mvcamera';
            this.initCanvas();
        },
        // 测试使用，相机3还没接入时使用静态图片代替
        showStaticImage(){
            if (!this.canvas || !this.cameraEnabled) return;
            
            const img = new Image();
            img.onload = () => {
                // 调整 Canvas 尺寸以适应图片 (可选，视需求而定)
                // 这里为了保持布局稳定，通常不改变 Canvas CSS 尺寸，但内部分辨率要匹配
                this.canvas.width = img.width;
                this.canvas.height = img.height;
                
                // 更新图片信息用于显示
                this.imageInfo.width = img.width;
                this.imageInfo.height = img.height;
                this.imageInfo.centroidX = '-'; // 静态图无质心数据
                this.imageInfo.centroidY = '-';

                // 绘制
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.drawImage(img, 0, 0);
                
                // 如果需要在静态图上也画十字，可以调用
                if(this.drawCross){
                    this.drawCenterCross(this.canvas.width, this.canvas.height);
                }
            };
            img.src = this.camera3Source;
        },
        initCanvas(){
            this.canvas  = this.$refs.cameraCanvas;
            if(this.canvas){
                this.ctx = this.canvas.getContext('2d');
                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.font = "20px Arial";
                this.ctx.fillStyle = "#666";
                this.ctx.textAlign = "center";
                this.ctx.fillText("无信号", this.canvas.width/2, this.canvas.height/2);
            }
        },
        initSocket(){
            if(typeof io === 'undefined'){
                console.log('未找到 socket.io.js');
                return;
            }
            this.socket = io('http://127.0.0.1:8090');
            // 连接socket
            this.socket.on('connect',()=>{
                console.log('Socket 连接成功');
            });
            //   断开socket
            this.socket.on('disconnect', ()=>{
                console.log('Socket 断开成功');
                this.isConnected = flase;
            });
            // 连接相机
            this.socket.on('camera_connected', (data) => {
                if(data.success) {
                    this.isConnected = true;
                    this.cameraEnabled = true;
                    this.isVirtualCamera = data.isVirtualCamera || false;
                    this.cameraType = data.cameraType || 'mvcamera';

                    // 虚拟相机（相机4）不需要加载SDK参数
                    if(this.cameraType === 'virtual'){
                        this.$message.success(data.message || "虚拟相机已就绪，请上传图像文件");
                        return;
                    }

                    // SDI相机（相机3）加载SDI配置
                    if(this.cameraType === 'sdi'){
                        this.loadCameraConfig(()=>{
                            this.syncSDISettings();
                            this.$message.success(data.message || "SDI采集已连接");
                        });
                        return;
                    }

                    // MvCamera真实相机（相机1/2）：加载并应用配置
                    this.loadCameraConfig(()=>{
                        const currentId = this.getCameraIntId(this.selectedCamera);
                        if(data.cameraId === currentId){
                            this.applyAllCameraParams(currentId);
                            this.syncCurrentCamSettings();
                            this.$message.success("相机已连接，已应用默认配置");
                        }
                    })
                }
            });
            // 监听错误
            this.socket.on('camera_error', (data) => {
                this.$message.error(data.message || '相机错误');
                // this.isConnected = false;
            });
            this.socket.on('camera_msg', (data) => {
                if (data.success) {
                    this.$message.success(data.message);
                } else {
                    this.$message.warning(data.message);
                }
            });
            // 接收图像
            this.socket.on('camera_frame', (frameData) => {
                this.handleNewFrame(frameData);
            });
        },
        // 放缩模式选择开关
        toggleZoomMode() {
            this.isZoomMode = !this.isZoomMode;
            if (!this.isZoomMode) {
                // 如果关闭模式，取消当前的拖拽状态
                this.isSelecting = false;
            }
        },
        getCanvasCoordinates(e) {
            const rect = this.canvas.getBoundingClientRect();
            // 计算比例因子：内部分辨率 / 显示尺寸
            const scaleX = this.canvas.width / rect.width;
            const scaleY = this.canvas.height / rect.height;

            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        },

        onMouseDown(e) {
            if (!this.isZoomMode || !this.cameraEnabled) return;
            
            // 【修改】使用转换后的坐标
            const coords = this.getCanvasCoordinates(e);
            this.selectionStart = { x: coords.x, y: coords.y };
            this.selectionCurrent = { ...this.selectionStart };
            this.isSelecting = true;
        },

        onMouseMove(e) {
            if (!this.isSelecting) return;
            
            // 【修改】使用转换后的坐标，并限制在分辨率范围内
            const coords = this.getCanvasCoordinates(e);
            let x = Math.max(0, Math.min(this.canvas.width, coords.x));
            let y = Math.max(0, Math.min(this.canvas.height, coords.y));
            
            this.selectionCurrent = { x, y };
        },

        onMouseUp(e) {
            if (!this.isSelecting) return;
            this.isSelecting = false;
            
            // 1. 计算 Canvas 上的框选矩形 (此时已经是内部分辨率坐标了，直接用)
            const startX = Math.min(this.selectionStart.x, this.selectionCurrent.x);
            const startY = Math.min(this.selectionStart.y, this.selectionCurrent.y);
            const w = Math.abs(this.selectionCurrent.x - this.selectionStart.x);
            const h = Math.abs(this.selectionCurrent.y - this.selectionStart.y);

            if (w < 10 || h < 10) return;

            this.isZoomMode = false;

            // 2. 计算新的视口
            // ... (后续逻辑保持不变，因为现在的 x,y,w,h 已经是正确的 Canvas 坐标了) ...
            const currentView = this.viewRect || { 
                x: 0, y: 0, 
                w: Number(this.imageInfo.width), 
                h: Number(this.imageInfo.height) 
            };

            // 注意：这里因为已经是 Canvas 坐标，比例因子计算方式略有不同
            // 如果 viewRect 为空（全图），Canvas 坐标就是原图坐标，比例为 1
            // 如果 viewRect 不为空（已经是局部），需要根据 Canvas 宽度反推回原图
            const scaleX = currentView.w / this.canvas.width;
            const scaleY = currentView.h / this.canvas.height;

            let newX = currentView.x + (startX * scaleX);
            let newY = currentView.y + (startY * scaleY);
            let newW = w * scaleX;
            let newH = h * scaleY;

            // ... (后续宽高比修正逻辑保持不变) ...
            
            // 宽高比修正代码参考：
            const canvasRatio = this.canvas.width / this.canvas.height;
            const selectRatio = newW / newH;
            if (selectRatio > canvasRatio) {
                const targetH = newW / canvasRatio;
                newY -= (targetH - newH) / 2;
                newH = targetH;
            } else {
                const targetW = newH * canvasRatio;
                newX -= (targetW - newW) / 2;
                newW = targetW;
            }

            this.viewRect = { x: newX, y: newY, w: newW, h: newH };

            if (this.selectedCamera === 4) {
                this.showStaticImage();
            }
        },
        resetZoom() {
            this.viewRect = null;        // 清空视口，handleNewFrame 会自动切回全图
            this.isZoomMode = false;     // 退出框选模式按钮高亮
            this.isSelecting = false;    // 停止拖拽状态
            this.selectionStart = {x:0, y:0};
            this.selectionCurrent = {x:0, y:0};

            if (this.selectedCamera === 4) {
                this.showStaticImage();
            }
        },
        handleNewFrame(data){
            if(!this.ctx || !this.cameraEnabled) return;
            
            this.imageInfo.width = data.width;
            this.imageInfo.height = data.height;
            this.imageInfo.centroidX = data.centroidX;
            this.imageInfo.centroidY = data.centroidY;

            if(this.canvas.width !== data.width || this.canvas.height !== data.height){
                this.canvas.width = data.width;
                this.canvas.height = data.height;
                this.viewRect = null;
            }

            const img = new Image();
            img.onload = () => {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                if(this.viewRect){
                    this.ctx.drawImage(
                        img,
                        this.viewRect.x, this.viewRect.y, this.viewRect.w, this.viewRect.h,
                        0, 0, this.canvas.width, this.canvas.height
                    );
                }
                else{
                    this.ctx.drawImage(img, 0, 0, this.canvas.width, this.canvas.height);
                }
                
                if(this.drawCross){
                    this.drawCenterCross(this.canvas.width, this.canvas.height);
                }
                if(this.drawCentroid & data.centroidX > 0 & data.centroidY > 0){
                    let drawX, drawY;
                    if (this.viewRect) {
                        // 如果在放大模式，需要将原图坐标映射到 Canvas 坐标
                        const scaleX = this.canvas.width / this.viewRect.w;
                        const scaleY = this.canvas.height / this.viewRect.h;
                        drawX = (data.centroidX - this.viewRect.x) * scaleX;
                        drawY = (data.centroidY - this.viewRect.y) * scaleY;

                        // 只有质心在当前视野内才绘制
                        if (drawX < 0 || drawX > this.canvas.width || drawY < 0 || drawY > this.canvas.height) {
                            drawX = -1; // 标记为不绘制
                        }
                    } else {
                        // 全图模式，直接绘制
                        drawX = data.centroidX;
                        drawY = data.centroidY;
                    }
                    if (drawX !== -1) {
                        this.drawCentroidPoint(drawX, drawY);
                    }
                }
                // 绘制黄色交互框
                if(this.isSelecting){
                    const w = this.selectionCurrent.x - this.selectionStart.x;
                    const h = this.selectionCurrent.y - this.selectionStart.y;
                    
                    this.ctx.save();
                    this.ctx.beginPath();
                    this.ctx.lineWidth = 2;
                    this.ctx.strokeStyle = '#E6A23C'; // ElementUI Warning Color
                    this.ctx.setLineDash([6, 4]);
                    this.ctx.strokeRect(this.selectionStart.x, this.selectionStart.y, w, h);
                    this.ctx.restore();
                }
            };
            img.src = data.image;
        },
        drawCenterCross(w, h){
            const centerX = w / 2;
            const centerY = h / 2;

            // 1. 绘制横线
            this.ctx.beginPath();
            this.ctx.strokeStyle = '#00FF00'; 
            this.ctx.lineWidth = 1;
            this.ctx.moveTo(0, centerY);
            this.ctx.lineTo(w, centerY);
            this.ctx.stroke();

            // 2. 绘制竖线 (分开绘制)
            this.ctx.beginPath();
            // 重新设置样式，防止状态污染
            this.ctx.strokeStyle = '#00FF00';
            this.ctx.lineWidth = 1;
            this.ctx.moveTo(centerX, 0);
            this.ctx.lineTo(centerX, h);
            this.ctx.stroke();

            // console.log(`Drawing Cross: W=${w}, H=${h}, CX=${centerX}, CY=${centerY}`);
        },
        drawCentroidPoint(x,y){
            this.ctx.beginPath();
            this.ctx.fillStyle = 'red';
            this.ctx.arc(x, y, 5, 0, 2 * Math.PI);// 半径为5
            this.ctx.fill();
        },
        // 处理图片上传 - 发送到后端进行质心分析
        handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            // 创建FormData发送到后端API
            const formData = new FormData();
            formData.append('image', file);

            axios.post('/api/virtual-camera/upload', formData, {
                headers: { 'Content-Type': 'multipart/form-data' }
            }).then(res => {
                if (res.data.success && res.data.frameData) {
                    // 使用后端返回的帧数据（包含质心计算结果）
                    this.handleNewFrame(res.data.frameData);
                    this.$message.success('图片上传成功，已计算质心');
                } else {
                    this.$message.error(res.data.message || '图片处理失败');
                }
            }).catch(err => {
                this.$message.error('图片上传失败: ' + err.message);
            });

            // 清空input以便重复选择同一文件
            e.target.value = '';
        },
        sendCmd(device, cmd, params = {}, wait_response = false, successMsg = "指令发送成功"){
            axios.post('/api/command/send',{
                device: device,
                cmd: cmd,
                params: params,
                wait_response: wait_response,
                timeout: 1.0
            }).then(res => {
                if(res.data.success){
                    this.$message.success(successMsg);
                }
                else{
                    this.$message.error('指令发送失败' + res.data.message);
                }
            }).catch(err => {
                this.$message.error('通信失败' + err);
            })
        },
        setLaserHorizontal(){
            // 发送水平到位指令
            // 超参数
            const targetPos = 114953
            this.sendCmd('three_axis_motor', 'set_horizontal_axis_pos', {pos: targetPos}, false, "水平到位指令已发送");
        },
        setLaserRotation(){
            // 发送旋转到位指令
            // 超参数
            const targetPos = 8624;
            this.sendCmd('three_axis_motor', 'set_rotation_axis_pos', { pos: targetPos }, false, '指示激光旋转到位指令已发送');
        },
        setTargetHorizontalZero(){
            // 发送水平归零指令
            this.sendCmd('three_axis_motor', 'set_horizontal_axis_pos_zero', {}, false, '靶标水平轴正在归零...');
        },
        setTargetRotationZero(){
            // 发送旋转归零指令
            this.sendCmd('three_axis_motor', 'set_rotation_axis_pos_zero', {}, false, '靶标旋转轴正在归零...');
        },
        setTargetHorizontal(){
            // 发送水平到位指令
            // 与指示激光水平到位相同
            // 超参数
            const targetPos = 114953; 
            this.sendCmd('three_axis_motor', 'set_horizontal_axis_pos', { pos: targetPos }, false, '靶标水平到位指令已发送');
        },
        setTargetRotation(){
            // 发送旋转到位指令
            // 该函数无用，切换靶标使用setTarget()函数
        },
        toggleLaser(){
            this.laserOn = !this.laserOn;
            // 发送开/关指令
            let powerVal = parseInt(this.laserPower);
            if (powerVal < 0) powerVal = 0;
            if (powerVal > 100) powerVal = 100;
            const valToSend = this.laserOn ? powerVal : 0;
            this.sendCmd('light_source', 'set_indicator_laser_power', { power: valToSend }, false,
                this.laserOn ? `指示激光已打开 (功率: ${valToSend})` : '指示激光已关闭');
        },
        updateLaserPower(){
            if (!this.laserOn) return;
            const val = parseInt(this.laserPower);
            this.sendCmd('light_source', 'set_indicator_laser_power', { power: val }, false, `激光功率已更新为 ${val}`);
        },
        toggleVisibleLight(){
            this.visibleLightOn = !this.visibleLightOn;
            // 发送开/关指令
            let lightVal = parseInt(this.visibleLightPower);
            if (lightVal < 0) lightVal = 0;
            if (lightVal > 100) lightVal = 100;
            const valToSend = this.visibleLightOn ? lightVal : 0;
            this.sendCmd('light_source', 'set_visible_light_power', { light: valToSend }, false,
                this.visibleLightOn ? `可见光已打开 (亮度: ${valToSend})` : '可见光已关闭');
        },
        updateVisibleLightPower(){
            if (!this.visibleLightOn) return;
            const val = parseInt(this.visibleLightPower);
            this.sendCmd('light_source', 'set_visible_light_power', { light: val }, false, `可见光亮度已更新为 ${val}`);
        },
        toggleBlackbody(){
            this.blackbodyOn = !this.blackbodyOn;
            // 发送开/关指令
            let tempVal = parseInt(this.blackbodyTemperature);
            if (tempVal < 0) tempVal = 0;
            if (tempVal > 100) tempVal = 100;
            const valToSend = this.blackbodyOn ? tempVal : 0;
            this.sendCmd('light_source', 'set_blackbody_temperature', { temperature: valToSend }, false,
                this.blackbodyOn ? `黑体已打开 (温度: ${valToSend})` : '黑体已关闭');
        },
        updateBlackbodyTemperature(){
            if (!this.blackbodyOn) return;
            const val = parseInt(this.blackbodyTemperature);
            this.sendCmd('light_source', 'set_blackbody_temperature', { temperature: val }, false, `黑体温度已更新为 ${val}`);
        },
        nudgeHorizontal(){
            // 发送水平微调指令（fineMoveX）
            const val = parseInt(this.fineMoveX);
            if (isNaN(val) || val === 0) {
                this.$message.warning('微调值为0或无效，不发送指令');
                return;
            }
            if (val > 0) {
                this.sendCmd('three_axis_motor', 'set_horizontal_axis_forword_move', { distance: Math.abs(val) }, false, `水平正向微调 ${val}`);
            } else {
                this.sendCmd('three_axis_motor', 'set_horizontal_axis_backword_move', { distance: Math.abs(val) }, false, `水平反向微调 ${Math.abs(val)}`);
            }
        },
        nudgeRotation(){
            // 发送旋转微调指令（fineRotate）
            const val = parseInt(this.fineRotate);
            if (isNaN(val) || val === 0) {
                this.$message.warning('微调值为0或无效，不发送指令');
                return;
            }
            if (val > 0) {
                this.sendCmd('three_axis_motor', 'set_rotation_axis_forword_rotate', { angle: Math.abs(val) }, false, `旋转正向微调 ${val}`);
            } else {
                this.sendCmd('three_axis_motor', 'set_rotation_axis_backword_rotate', { angle: Math.abs(val) }, false, `旋转反向微调 ${Math.abs(val)}`);
            }
        },
        setTarget(targetAngle, targetLabel = ''){
            // 发送靶标选择指令
            if(typeof targetAngle !== 'number'){
                this.$message.warning('无效的靶标参数');
                return;
            }
            const msgLabel = targetLabel ? ` [${targetLabel}]` : '';
            this.sendCmd(
                'three_axis_motor', 
                'set_rotation_axis_pos', 
                { pos: targetAngle }, 
                false, 
                `正在切换至靶标${msgLabel} (角度: ${targetAngle})`
            );
        }
    },
    mounted(){
        this.initCanvas();
        this.initSocket();
        this.loadCameraConfig();
    },
    beforeDestroy(){
        if(this.socket){
            this.socket.disconnect();
        }
    }
});
</script>
</body>
</html>
