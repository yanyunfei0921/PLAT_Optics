<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script type="text/javascript" src="/static/jsscripts/vue.js"></script>
    <script type="text/javascript" src="/static/jsscripts/axios.js"></script>
    <script type="text/javascript" src="/static/jsscripts/elementui/lib-master/index.js"></script>

    <link rel="stylesheet" href="/static/jsscripts/elementui/lib-master/theme-chalk/index.css">
    <style>
        html {
            height: 100%;
        }
        body {
            margin: 0;
            height: 100%;
            overflow: hidden;
            background: #f5f7fa;
        }
        /* 布局容器 */
        .app-root {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .layout-container {
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* 顶部样式 */
        .topbar {
            background: #ffffff;
            border-bottom: 1px solid #ebeef5;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0; /* 防止被压缩 */
        }
        .topbar-title {
            font-size: 18px;
            font-weight: 600;
            color: #303133;
        }
        .topbar-user {
            color: #606266;
        }
        .link-margin-left {
            margin-left: 12px;
        }

        /* 菜单栏样式 */
        .menubar {
            padding: 0;
            background: #ffffff;
            border-bottom: 1px solid #ebeef5;
            flex-shrink: 0;
        }
        .menu-no-border {
            border-bottom: none;
        }

        /* 主内容区域包裹器 */
        .main-content-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden; /* 隐藏溢出，iframe内部处理滚动 */
            box-sizing: border-box;
        }

        /* 首页内容样式 */
        .home-content {
            padding: 16px;
            height: 100%;
            overflow: auto; /* 首页内容可滚动 */
            box-sizing: border-box;
        }
        .two-cols {
            display: flex;
            gap: 16px;
            height: 100%;
        }
        .left-panel {
            flex: 1;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 4px;
        }
        .intro-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .right-panel {
            flex: 1;
            background: #ffffff;
            padding: 16px;
            overflow: auto;
            border-radius: 4px;
        }
        .title-no-margin {
            margin-top: 0;
        }

        /* Iframe 容器样式 */
        .iframe-wrapper {
            width: 100%;
            height: 100%;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
    </style>
    
    <title>光电测试系统软件平台</title>
</head>

<body>
    <div id="app" class="app-root">
        <el-container class="layout-container">
            <el-header height="60px" class="topbar">
                <div class="topbar-title">光电测试系统软件平台</div>
                <div class="topbar-user">
                    用户：{{ usrname }}
                    <el-link type="primary" class="link-margin-left" @click="changeUsrName">切换</el-link>
                </div>
            </el-header>

            <el-header height="44px" class="menubar">
                <el-menu mode="horizontal" :default-active="currentKey"
                        background-color="#ffffff"
                        text-color="#303133" active-text-color="#409EFF"
                        class="menu-no-border" @select="handleSelect">
                    <el-menu-item index="index">首页</el-menu-item>
                    <el-menu-item index="serialSettingUrl">串口设置</el-menu-item>
                    <el-menu-item index="opticalAxisUrl">光轴一致性测试</el-menu-item>
                    <el-menu-item index="dynamicTargetUrl">动态目标模拟</el-menu-item>
                    <el-menu-item index="laserDistanceUrl">激光模拟测距</el-menu-item>
                    <el-menu-item index="laserEnergyUrl">激光能量测试</el-menu-item> 
                    <el-menu-item index="testRecordUrl">测试记录</el-menu-item>
                </el-menu>
            </el-header>

            <div class="main-content-wrapper">
                
                <div class="home-content" v-show="currentKey === 'index'">
                    <div class="two-cols">
                        <div class="left-panel">
                            <img src="/static/images/system_intro.png" alt="系统介绍" class="intro-image" />
                        </div>
                        <div class="right-panel">
                            <h2 class="title-no-margin">光电测试系统软件平台使用说明</h2>
                            <p>本平台用于支撑光电测试相关实验流程与数据记录，提供基础的设备管理、测试任务组织与结果查看能力。请在进行任何操作前，确认设备连接与安全注意事项。</p>
                            <p>使用前请阅读操作规程：避免直视激光，佩戴必要的防护器材；在测试区域保持整洁，确保电缆与设备稳固；进行能量或测距测试时，注意周围人员与反射面，防止误伤。</p>
                            <p>若首次使用，建议先进入“串口设置”完成与设备的通信配置，然后根据需要选择“光轴一致性测试”“动态目标模拟”“激光模拟测距”“激光能量测试”等功能模块。</p>
                            <p>测试完成后，可在“测试记录”查看与导出报告。出现连接或权限问题时，请联系管理员或重新登录后重试。</p>
                            <p>以上文字仅为占位示例，用于演示右侧内容区域可单独滚动的效果。请根据实际业务替换为正式说明文档。</p>
                            <p>为了展示滚动效果，附加一些额外文本：当内容高度超过区域高度时，可以在此区域内滚动，而页面整体保持固定，不发生全局滚动。</p>
                            <p>更多说明文本……更多说明文本……更多说明文本……更多说明文本……更多说明文本……更多说明文本……更多说明文本……更多说明文本……</p>
                        </div>
                    </div>
                </div>

                <div class="iframe-wrapper" 
                     v-for="(url, key) in urlConfig" 
                     :key="key" 
                     v-show="currentKey === key">
                    <iframe 
                        v-if="loadedKeys.includes(key)"
                        :src="url">
                    </iframe>
                </div>

            </div>
        </el-container>
    </div>

    <script>
        var vm = new Vue({
            el: "#app",
            data: {
                usrname: "未登录",
                admin: "admin",
                
                // 修改点：使用 currentKey 跟踪当前 Tab
                currentKey: 'index',
                // 修改点：使用 loadedKeys 跟踪已加载过的页面，实现懒加载
                loadedKeys: [],

                urlConfig: {
                    serialSettingUrl: "/serialSetting",
                    opticalAxisUrl: "/opticalAxis",
                    laserDistanceUrl: "/laserDistance",
                    dynamicTargetUrl: "/dynamicTarget",
                    laserEnergyUrl: "/laserEnergy",
                    testRecordUrl: "/testRecord"
                },
            },
            created() {
                this.resolveUrl();
            },
            methods: {
                resolveUrl(){
                    try{
                        const n = window.sessionStorage.getItem('usrname') || '';
                        if(n){
                            this.usrname = n;
                            return;
                        }
                    }catch(e){}
                    this.usrname = "未登录";
                    window.location.href = "/login";
                },
                changeUsrName(){
                    try{ window.sessionStorage.removeItem('usrname'); }catch(e){}
                    window.location.href = "/login";
                },
                handleSelect(key, keyPath) {
                    // 修改点：更新当前激活的 key
                    this.currentKey = key;

                    // 如果不是首页，且该页面从未加载过，则加入已加载列表
                    // 这样 iframe 才会第一次创建并加载 URL
                    if (key !== 'index' && !this.loadedKeys.includes(key)) {
                        this.loadedKeys.push(key);
                    }
                    
                    // 可选：强制刷新（通常不需要，Vue会自动响应数据变化）
                    // this.$forceUpdate();
                },

            }
        })
    </script>

</body>
</html>